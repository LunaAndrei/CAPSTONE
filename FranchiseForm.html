<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tricycle Franchise Application Form</title>
    <link rel="stylesheet" href="FranchiseForm.css">
    <link rel="icon" href="Pic/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/boxicons/css/boxicons.min.css">
    <script src="https://code.iconify.design/2/2.1.0/iconify.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <img src="Pic/favicon.png" alt="Logo">
        <h2>Menu</h2>
        <ul>
            <li><a href="Dashboard.html"><i class="bx bxs-dashboard"></i> Dashboard</a></li>
            <li><a href="VeryfingDocuments.html"><i class='bx bxs-file-find'></i> Verifying Documents</a></li>
            <li><a href="AdminOccuForm.html"><i class="fas fa-id-card icon"></i> Occupational Form</a></li>
            <li><a href="FranchiseForm.html"><i class="fas fa-id-card icon"></i> Franchise Form</a></li>
            <li><a href="payment.html"><i class='bx bxs-wallet-alt'></i> Payment</a></li>
            <b>Others</b>
            <li><a href=""id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <div class="main-content">
        <h1>Tricycle Franchise Application Form</h1>

        <div id="alert-container" class="alert hidden">
            <span id="alert-icon"></span>
            <span id="alert-message"></span>
        </div>

        <form action="http://localhost:8000/submit" method="POST" enctype="multipart/form-data">
            <!-- Application Type Section -->
            <div class="form-group">
                <div class="form-field">
                    <label for="applicationType">Application Type:</label>
                    <select id="applicationType" name="applicationType" required>
                        <option value="new">New</option>
                        <option value="renewal">Renewal</option>
                    </select>
                </div>
            </div>

            <!-- Personal Details Section -->
            <div class="personal-details">
                <div class="form-field">
                    <label for="nameApplicant">Name of Applicant</label>
                    <input type="text" id="nameApplicant" name="nameApplicant" required>
                </div>
                <div class="form-field">
                    <label for="date">Date</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div class="form-field">
                    <label for="route">Route</label>
                    <input type="text" id="route" name="route" required>
                </div>
                <div class="form-field">
                    <label for="occupation">Occupation</label>
                    <input type="text" id="occupation" name="occupation" required>
                </div>
            </div>

            <!-- Address Section -->
            <div class="address-group">
                <div class="form-field">
                    <label for="barangay">Barangay</label>
                    <input type="text" id="barangay" name="barangay" required>
                </div>
                <div class="form-field">
                    <label for="municipality">Municipality</label>
                    <input type="text" id="municipality" name="municipality" required>
                </div>
                <div class="form-field">
                    <label for="province">Province</label>
                    <input type="text" id="province" name="province" required>
                </div>
            </div>

            <!-- Ownership and Units Section -->
            <div class="ownership-units-group">
                <div class="form-field">
                    <label for="typeOwnership">Type of Ownership</label>
                    <select id="typeOwnership" name="typeOwnership" required>
                        <option value="single">Single Proprietorship</option>
                        <option value="cooperative">Cooperative</option>
                        <option value="corporation">Corporation</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="numUnits">Number of Units</label>
                    <input type="number" id="numUnits" name="numUnits" required>
                </div>
            </div>

            <!-- Units Table -->
            <div class="form-field">
                <label for="unitDescription">Description of Ready Units</label>
                <table class="unit-table" id="unitTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Model</th>
                            <th>Motor No.</th>
                            <th>Chassis No.</th>
                            <th>Plate No.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" name="unitName[]" required></td>
                            <td><input type="text" name="unitModel[]" required></td>
                            <td><input type="text" name="unitMotorNo[]" required></td>
                            <td><input type="text" name="unitChassisNo[]" required></td>
                            <td><input type="text" name="unitPlateNo[]" required></td>
                        </tr>
                    </tbody>
                </table>
                <div class="button-container">
                    <button type="button" class="add-unit-button" onclick="addUnitRow()">Add Unit</button>
                    <button type="button" class="deletebutton" onclick="deleteUnitRow()">Delete Unit</button>
                </div>
            </div>

            <!-- Driver Details -->
                        <div class="driver-license-group">
                <div class="form-field">
                    <label for="officialDriver">Name of Official Driver</label>
                    <input type="text" id="officialDriver" name="officialDriver" required>
                </div>
                <div class="form-field">
                    <label for="licenseNumber">License Number</label>
                    <input type="text" id="licenseNumber" name="licenseNumber" required>
                </div>
            </div>

            <!-- Certification Section -->
            <div class="certification-section">
                <div class="checkbox-container">
                    <input type="checkbox" id="consent" name="consent" required>
                    <label for="consent" class="consent-text">
                        I hereby certify that all the information provided are true and correct based on personal knowledge of facts and further consent to the collection, use, and processing of my personal information by Municipal Government of San Luis for the purpose of processing my Occupational Permit application.
                    </label>
                </div>

                <p>
                    <strong>San Luis, Batangas dated</strong> <input type="date" id="certificationDate" name="certificationDate">
                </p>
                <p>
                    <strong>Signature of Applicant</strong> <input type="file" id="signatureApplicant" name="signatureApplicant">
                </p>
                <p>
                    <strong>Subscribed and sworn to before me:</strong>
                    This <input type="text" id="subscribedDate" name="subscribedDay" placeholder="Day" required> day of <input type="text" id="subscribedMonth" name="subscribedMonth" placeholder="Month" required>, <input type="text" id="subscribedYear" name="subscribedYear" placeholder="Year" required> at San Luis, Batangas.
                </p>
                <p>
                    He/She presented to me his/her Community Tax Certificate No. <input type="text" id="communityTaxCertNo" name="communityTaxCertNo" placeholder="Certificate No." required> issued at San Luis, Batangas on <input type="date" id="certificateIssueDate" name="certificateIssueDate" required>.
                </p>
                <p>
                    <strong>MA. ANN. DE GRACIA</strong><br>
                    Municipal Vice Mayor
                </p>
                <p>
                    <strong>Issued By:</strong> <input type="text" id="inspectedBy" name="inspectedBy" placeholder="Name" required>
                </p>
            </div>

            <!-- Submit and Clear Buttons -->
            <div class="form-group button-group">
                <button type="submit" onclick="confirmSubmission(event)">Submit</button>
                <button type="button" class="clear-button" onclick="clearForm()">Clear Form</button>
            </div>
        </form>
    </div>

    <script>
        
        async function confirmSubmission(event) {
    event.preventDefault(); // Prevent immediate form submission
    const confirmed = confirm("Are you sure you want to submit this form?");

    if (confirmed) {
        try {
            const form = document.querySelector('form');
            const formData = new FormData(form);

            const response = await fetch(form.action, {
                method: form.method,
                body: formData,
            });

            if (response.ok) {
                showAlert('Form submitted successfully!', 'success');
                form.reset(); // Clear the form after successful submission
            } else {
                const errorData = await response.json();
                showAlert(`Error: ${errorData.message}`, 'error');
            }
        } catch (error) {
            showAlert(`Submission failed: ${error.message}`, 'error');
        }
    }
}

function addUnitRow() {
    const table = document.getElementById('unitTable').getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();
    const cells = ['unitName[]', 'unitModel[]', 'unitMotorNo[]', 'unitChassisNo[]', 'unitPlateNo[]'];

    cells.forEach(cell => {
        const newCell = newRow.insertCell();
        const input = document.createElement('input');
        input.type = 'text';
        input.name = cell;
        input.required = true;
        newCell.appendChild(input);
    });
}

function deleteUnitRow() {
    const table = document.getElementById('unitTable');
    const rowCount = table.rows.length;

    if (rowCount > 2) {
        table.deleteRow(rowCount - 1);
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alertMessage = document.getElementById('alert-message');
    const alertIcon = document.getElementById('alert-icon');

    alertMessage.textContent = message;

    if (type === 'success') {
        alertIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
        alertContainer.className = 'alert success';
    } else if (type === 'error') {
        alertIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
        alertContainer.className = 'alert error';
    }

    alertContainer.style.display = 'flex'; // Ensure it is visible
    
    window.scrollTo(0, 0); // Scroll to the top

    setTimeout(() => {
        alertContainer.style.display = 'none'; // Hide after 2 seconds
        // Only clear the form if the submission was successful
        if (type === 'success') {
            clearForm(); 
        }
    }, 2000); // Hide alert after 2 seconds
}

function clearForm() {
    const form = document.querySelector('form');
    form.reset();
}

// Renewal Function
// Modify the checkRenewalEligibility function
async function checkRenewalEligibility() {
    const applicationType = document.getElementById('applicationType').value;

    if (applicationType === 'renewal') {
        const tfid = prompt('Please enter your TFID for renewal:'); // Ask user to input TFID

        if (tfid) {
            try {
                const response = await fetch(`http://localhost:8000/check-renewal?tfid=${encodeURIComponent(tfid)}`);
                const data = await response.json();

                if (data.exists) {
                    const lastRenewalDate = new Date(data.lastRenewalDate);
                    const oneYearAgo = new Date();
                    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

                    if (lastRenewalDate <= oneYearAgo) {
                        alert('You can renew the application.');
                        fetchExistingRecordByTFID(tfid); // Fetch record based on TFID
                    } else {
                        alert('Renewal is not allowed. Please wait until one year has passed since the last renewal.');
                        document.getElementById('applicationType').value = 'new'; // Reset to new
                    }
                } else {
                    alert('No existing record found for renewal.');
                    document.getElementById('applicationType').value = 'new'; // Reset to new
                }
            } catch (error) {
                console.error('Error checking renewal:', error);
                alert('An error occurred while checking renewal status.');
            }
        } else {
            alert('Please enter a valid TFID.');
            document.getElementById('applicationType').value = 'new'; // Reset to new
        }
    }
}

// Fetch existing record based on TFID
async function fetchExistingRecordByTFID(tfid) {
    try {
        const response = await fetch(`http://localhost:8000/fetch-record?tfid=${encodeURIComponent(tfid)}`);

        const data = await response.json();

        if (data.success) {
            const record = data.record;

            // Autofill the form fields as before
            document.getElementById('nameApplicant').value = record.nameApplicant || '';
            document.getElementById('route').value = record.route || '';
            document.getElementById('barangay').value = record.barangay || '';
            document.getElementById('municipality').value = record.municipality || '';
            document.getElementById('province').value = record.province || '';
            document.getElementById('occupation').value = record.occupation || '';

            // Set the type of ownership
            const typeOwnershipSelect = document.getElementById('typeOwnership');
            typeOwnershipSelect.value = record.typeOwnership || 'single';

            // Update unit table
            const unitTableBody = document.getElementById('unitTable').getElementsByTagName('tbody')[0];
            unitTableBody.innerHTML = ''; // Clear existing rows

            if (record.units && record.units.length > 0) {
                record.units.forEach(unit => {
                    const newRow = unitTableBody.insertRow();
                    newRow.insertCell().innerHTML = `<input type="text" name="unitName[]" value="${unit.unit_name}" required>`;
                    newRow.insertCell().innerHTML = `<input type="text" name="unitModel[]" value="${unit.unit_model}" required>`;
                    newRow.insertCell().innerHTML = `<input type="text" name="unitMotorNo[]" value="${unit.motor_no}" required>`;
                    newRow.insertCell().innerHTML = `<input type="text" name="unitChassisNo[]" value="${unit.chassis_no}" required>`;
                    newRow.insertCell().innerHTML = `<input type="text" name="unitPlateNo[]" value="${unit.plate_no}" required>`;

                });
            }

            document.getElementById('numUnits').value = record.numUnits || '';
            document.getElementById('officialDriver').value = record.officialDriver || '';
            document.getElementById('licenseNumber').value = record.licenseNumber || '';
        }
    } catch (error) {
        console.error('Error fetching record:', error);
        alert('An error occurred while fetching the existing record.');
    }
}


document.getElementById('applicationType').addEventListener('change', checkRenewalEligibility);


document.addEventListener('DOMContentLoaded', () => {
    const applicationTypeSelect = document.getElementById('applicationType');
    const dateInput = document.getElementById('date');
    const certificationDateInput = document.getElementById('certificationDate');
    const certificateIssueDateInput = document.getElementById('certificateIssueDate');
    const subscribedDayInput = document.getElementById('subscribedDate');
    const subscribedMonthInput = document.getElementById('subscribedMonth');
    const subscribedYearInput = document.getElementById('subscribedYear');

    applicationTypeSelect.addEventListener('change', () => {
        const applicationType = applicationTypeSelect.value;

        if (applicationType === 'renewal') {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0'); // Get the day of the month (01-31)
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Get the month (01-12), months are zero-indexed
            const year = today.getFullYear(); // Get the year (e.g., 2024)

            // Set all the date-related inputs
            dateInput.value = today.toISOString().split('T')[0];
            certificationDateInput.value = today.toISOString().split('T')[0];
            certificateIssueDateInput.value = today.toISOString().split('T')[0];
            subscribedDayInput.value = day;
            subscribedMonthInput.value = month;
            subscribedYearInput.value = year;
        }
    });
});

document.getElementById('logoutButton').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default link behavior
            var confirmation = confirm("Are you sure you want to log out?");
            if (confirmation) {
                window.location.href = 'login.html'; // Redirect to the login page
            }
        });



    </script>
</body>
</html>
